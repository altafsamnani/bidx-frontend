<?php
if ( is_user_logged_in() ) {
?>
<div class="signup span4 well">
	<h3>Not available!</h3>
	<a href="<?php echo wp_logout_url( get_permalink() ); ?>" title="Logout">Logout</a> to use
</div>
<?php 
} else {
?>
<div class="signup span4 well">

	<form class="fieldset">
		<div class="formfield huge" data-validation='{"required":{"text":"This field is mandatory"},"typecheck":[{"custom":{"url":"/wp-admin/admin-ajax.php?action=bidx_request","apiurl":"groups/validateGroupName","apimethod":"get"}}]}'>
			<input type="text" name="groupName" placeholder="Your group name" class="highlight" value="">
		</div>
		<div class="formfield huge" data-validation='{"required":{"text":"This fields is mandatory"},"typecheck":[{"email":{"text":"This is not a valid e-mail address"}},{"custom":{"url":"/wp-admin/admin-ajax.php?action=bidx_request","apiurl":"members/validateUsername","apimethod":"get"}}]}'>
			<input type="email" name="username" placeholder="Your email address">
		</div>
		<div class="formfield huge" data-validation='{"required":{"text":"This fields is mandatory"}}'>
			<input type="password" name="password" placeholder="Your password">
		</div>
		<a href="#" class="btn btn-success jsCreateGroup">Create your group</a>
	</form>
	
	<div class="group-creation-progress">
		<p class="lead">Your group is being created</p>
		<div class="loader"></div>
		<p>This might take a moment of your time</p>
	</div>

	<!-- externalize this -->
	<script type="text/javascript">
    	$(function(){
    		/*
    			if handler sends back response it can include the following json:
    			{
					status: 'OK',
					redirect:'<URL to redirect too>'
				},
				{ //not yet implemented
					status: 'ERROR',
					fields: [{field:fieldname,error:errormessage}[,]]
				}
    		*/

    		$(".fieldset").form({
    			callToAction : '.jsCreateGroup', // the selector for submit button
    			errorClass : 'error', //the css class used as error message
    			url : '/wp-admin/admin-ajax.php?action=bidx_request',
    			apiurl : 'groups',
    			apimethod : 'post',
    			beforeSubmit : function(){
						var $this=$(".fieldset");
			    		$this.fadeOut("fast", function(){
			    			$(".group-creation-progress").fadeIn('fast');
			    		});
	    			},
	    			//custom error message for frontend registration in case group creation fails
	    			error: function(data){
	    				$(".group-creation-progress").html("<div class=\"text sub\">Group creation failed. Please reload the page and try again.<br/> If the problem persists, please contact us.");
	    				if(data.text) {
	    					$(".group-creation-progress").append(data.text);
	    				}
	    			}
	    			
	    		});

	    		(function() {
	    			/*custom event to fix field positioning when validation kicks in*/
	    			var fs = $(".fieldset");

	    			var startMargin = parseInt(fs.css("margin-top").replace("px",""));
 					//when change occurs count error messages for this fieldset an calculate margin correction
		    		$(".fieldset :input").change(correctMargins);
		    		$(".jsCreateGroup").click(correctMargins);
	    			function correctMargins() {
	    				var removeMargin = 0;
		    			//exclude

						var fields = fs.find(":input").map(function(){
		    				return $(this).attr("name")}).each(function(i,name){
		    					var match = JSON.stringify($(".fieldset").form("getElement",name).validation).match(/"error":true/g);
		    					if(match != null)
		    						removeMargin += 10;
		    				});
	    					fs.animate({
								"margin-top":startMargin-removeMargin
									}, 'fast');
				    			}

					})();
			});
    </script>
</div>
<?php 
}
?>
